# https://code.visualstudio.com/api/language-extensions/syntax-highlight-guide
# https://www.apeth.com/nonblog/stories/textmatebundle.html
#
# npx js-yaml syntaxes/opsi-script.tmLanguage.yaml > syntaxes/opsi-script.tmLanguage.json

scopeName: source.opsi-script
name: opsi-script
uuid: 08cd1012-1f35-44bf-a64a-ebf3f82c8978
fileTypes: [.opsiscript, .ins]
#foldingStartMarker: ^\[[^\]]+\]
#foldingStopMarker: ^\[[^\]]+\]

repository:
  core:
    patterns:
    - include: '#comments'
    - include: '#primary-sections'
    - include: '#secondary-sections'

  expressions:
    patterns:
    - include: '#brackets'
    - include: '#primary-section-keywords'
    - include: '#primary-section-operators'
    - include: '#primary-section-number'
    - include: '#literal-constant'
    - include: '#literal-variable'

  comments:
    patterns:
    - name: comment.line.semicolon.opsi-script
      match: ^(;).*$\n?
      captures:
        '1': {name: punctuation.definition.comment.opsi-script}

  brackets:
    patterns:
    - include: '#round-brackets'

  round-brackets:
    patterns:
    - name: meta.group.braces.round
      begin: \(
      beginCaptures:
        '0': {name: meta.brace.round.opsi-script}
      end: \)
      endCaptures:
        '0': {name: meta.brace.round.opsi-script}
      patterns:
      - include: '#expressions'

  literal-constant:
    patterns:
    - name: constant.language.builtin.percent.opsi-script
      match: '(?i)(%)(HostID|ScriptPath)(%)'
      captures:
        '1': {name: punctuation.percent.opsi-script}
        '2': {name: punctuation.percent.opsi-script}

  literal-variable:
    patterns:
    - name: variable.other.dollar.opsi-script
      match: '(\$)[$\w]+(\$)'
      captures:
        '1': {name: punctuation.dollar.opsi-script}
        '2': {name: punctuation.dollar.opsi-script}

  primary-section:
    patterns:
    - name: support.variable.builtin.opsi-script
      match: (?<!\.)(?i)\b(SetLogLevel)\b
    - name: support.function.builtin.logging.opsi-script
      match: (?<!\.)(?i)\b(comment|LogError|isFatalError)\b
    - name: support.function.builtin.list.opsi-script
      match: (?<!\.)(?i)\b(takeString|getValue)\b
    - name: support.function.builtin.string.opsi-script
      match: (?<!\.)(?i)\b(asConfidential|strPart|strLength|isRegexMatch)\b
    - name: support.function.builtin.numeric.opsi-script
      match: (?<!\.)(?i)\b(calculate)\b
    - name: support.function.builtin.service.opsi-script
      match: (?<!\.)(?i)\b(GetProductProperty)\b
    - name: support.function.builtin.subprocess.opsi-script
      match: (?<!\.)(?i)\b(ShellCall|GetLastExitcode)\b
    - include: '#comments'
    - include: '#primary-section-string'
    - include: '#expressions'
    - include: '#secondary-section-calls'

  primary-sections:
    patterns:
    - name: meta.primary-section.actions.opsi-script
      begin: (?i)^(\[)(Actions|Aktionen)(\])
      beginCaptures:
        #'1': {name: keyword.other.section-bracket-open.opsi-script}
        #'2': {name: entity.name.function.opsi-script}
        '2': {name: entity.name.type.primary-section.opsi-script}
        #'3': {name: keyword.other.section-bracket-close.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.sub.opsi-script
      begin: (?i)^(\[)(Sub\S+)(\])
      beginCaptures:
        #'1': {name: keyword.other.section-bracket-open.opsi-script}
        #'2': {name: entity.name.function.opsi-script}
        '2': {name: entity.name.type.primary-section.opsi-script}
        #'3': {name: keyword.other.section-bracket-close.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#primary-section'

  primary-section-keyword-storage:
    patterns:
    - name: storage.type.opsi-script
      match: (?i)(?<!\.)\b(DefVar|DefStringList|Set)\b

  primary-section-keywords:
    patterns:
    - include: '#primary-section-keyword-storage'

    - name: keyword.control.opsi-script
      match: (?i)\b(if|else|endif)\b

  primary-section-operators:
    patterns:
    - name: keyword.operator.wordlike.opsi-script
      match: \b(and|or|not)\b

  primary-section-string:
    patterns:
    - name: string.quoted.single.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'

    - name: string.quoted.double.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'

  primary-section-number:
    patterns:
    - name: constant.numeric.js
      match: (?xi)\b[0-9]+

  secondary-section-calls:
    patterns:
    - name: meta.secondary-section-call.without-arguments.opsi-script
      match: (?i)\b(ShellInAnIcon\S+|PatchTextFile\S+)\b
      captures:
        #'1': {name: entity.name.function.opsi-script}
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

  secondary-sections:
    patterns:

    - name: meta.secondary-section.shell-in-an-icon.opsi-script
      begin: ^(\[)(ShellInAnIcon[^\]]+)(\])
      beginCaptures:
        #'1': {name: keyword.other.section-bracket-open.opsi-script}
        #'2': {name: entity.name.function.opsi-script}
        '2': {name: entity.name.type.secondary-section-shell-in-an-icon.opsi-script}
        #'3': {name: keyword.other.section-bracket-close.opsi-script}
      while: ^(?!\[.*\]$)
      contentName: meta.embedded.block.shellscript
      patterns:
      - include: '#secondary-section'
      - include: source.shell

    - name: meta.secondary-section.patch-text-file.opsi-script
      begin: ^(\[)(PatchTextFile[^\]]+)(\])
      beginCaptures:
        #'1': {name: keyword.other.section-bracket-open.opsi-script}
        #'2': {name: entity.name.function.opsi-script}
        '2': {name: entity.name.type.secondary-section-patch-text-file.opsi-script}
        #'3': {name: keyword.other.section-bracket-close.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patch-text-file'

  secondary-section:
    patterns:
    - include: '#comments'
    - include: '#secondary-section-string'
    - include: '#literal-constant'
    - include: '#literal-variable'

  secondary-section-patch-text-file:
    patterns:
    - name: support.function.builtin.secondary-section.patchtextfile.opsi-script
      match: (?<!\.)(?i)\b(FindLine_Containing|DeleteTheLine|InsertLine)\b

  secondary-section-string:
    patterns:
    - name: string.quoted.single.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
      - include: '#literal-variable'

    - name: string.quoted.double.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
      - include: '#literal-variable'

patterns:
  - include: '#core'
