# https://code.visualstudio.com/api/language-extensions/syntax-highlight-guide
# https://www.apeth.com/nonblog/stories/textmatebundle.html
# https://github.com/microsoft/vscode/tree/main/extensions/markdown-basics
#
# npx js-yaml syntaxes/opsi-script.tmLanguage.yaml > syntaxes/opsi-script.tmLanguage.json
#
# "(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*
# matches:
#  "double quote (\") string"
#  'single quote (\') string'
#  string_without_quotes_and_whitespace


scopeName: source.opsi-script
name: opsi-script
uuid: 08cd1012-1f35-44bf-a64a-ebf3f82c8978
fileTypes: [.opsiscript, .ins]
#foldingStartMarker: ^\[[^\]]+\]
#foldingStopMarker: ^\[[^\]]+\]

repository:
  core:
    patterns:
    - include: '#comments'
    - include: '#primary-sections'
    - include: '#secondary-sections'

  expressions:
    patterns:
    - include: '#brackets'
    - include: '#primary-section-keywords'
    - include: '#primary-section-operators'
    - include: '#primary-section-number'
    - include: '#primary-section-string'
    - include: '#literal-constant'
    - include: '#literal-variable'

  comments:
    patterns:
    - name: comment.line.semicolon-or-hash.opsi-script
      match: ^\s*(;|#).*$\n?
      captures:
        '1': {name: punctuation.definition.comment.opsi-script}

  brackets:
    patterns:
    - include: '#round-brackets'

  round-brackets:
    patterns:
    - name: meta.group.braces.round
      begin: \(
      beginCaptures:
        '0': {name: meta.brace.round.opsi-script}
      end: \)
      endCaptures:
        '0': {name: meta.brace.round.opsi-script}
      patterns:
      - include: '#expressions'
      - include: '#primary-section-functions'

  literal-constant-slash:
    patterns:
    - name: constant.language.exit-params.opsi-script
      match: '(?i)(/)(Reboot|RebootWanted|ImmediateReboot|ImmediateLogout|ShutdownWanted)\b'

  literal-constant-percent:
    patterns:
    - name: constant.language.win-system-directories.opsi-script
      match: '(?i)(%)(ProgramFilesDir|ProgramFiles32Dir|ProgramFiles64Dir|ProgramFilesSysnativeDir|Systemroot|System|Systemdrive|ProfileDir)(%)'
    - name: constant.language.win-common-user.opsi-script
      match: '(?i)(%)(AllUsersProfileDir|CommonProfileDir|CommonStartMenuPath|CommonStartmenuDir|CommonAppdataDir|CommonDesktopDir|CommonStartupDir|CommonProgramsDir)(%)'
    - name: constant.language.win-default-user.opsi-script
      match: '(?i)(%)(DefaultUserProfileDir)(%)'
    - name: constant.language.win-current-user.opsi-script
      match: '(?i)(%)(AppdataDir|CurrentAppdataDir|CurrentStartmenuDir|CurrentDesktopDir|CurrentStartupDir|CurrentProgramsDir|CurrentSendToDir|CurrentProfileDir)(%)'
    - name: constant.language.win-all-nt-user-profiles.opsi-script
      match: '(?i)(%)(UserProfileDir|CurrentProfileDir)(%)'
    - name: constant.language.win-all-nt-user-profiles.opsi-script
      match: '(?i)(%)(UserProfileDir|CurrentProfileDir)(%)'
    - name: constant.language.opsi-script-path.opsi-script
      match: '(?i)(%)(ScriptPath|ScriptDir|ScriptDrive|OpsiscriptDir|WinstDir|OpsiscriptVersion|WinstVersion|Logfile|opsiScriptHelperPath|opsiTmpDir|opsiLogDir|opsidata|opsiapplog)(%)'
    - name: constant.language.network-info.opsi-script
      match: '(?i)(%)(Host|PCName|Username|IPName|IPAddress)(%)'
    - name: constant.language.service-data.opsi-script
      match: '(?i)(%)(HostID|opsiserviceURL|opsiServer|opsiDepotId|opsiserviceUser|opsiservicePassword|installingProdName|installingProdVersion|installingProduct)(%)'

  literal-constant:
    patterns:
    - name: constant.language.opsi-script
      match: '(?i)\b(PARAMSTR)\b'
    - include: '#literal-constant-percent'
    - include: '#literal-constant-slash'

  literal-variable:
    patterns:
    - name: variable.other.dollar.opsi-script
      match: '(\$)\S+(\$)'
      captures:
        '1': {name: punctuation.dollar.opsi-script}
        '2': {name: punctuation.dollar.opsi-script}
    - name: variable.other.percent.opsi-script
      match: '(%)\S+(%)'
      captures:
        '1': {name: punctuation.percent.opsi-script}
        '2': {name: punctuation.percent.opsi-script}

  # function-definition:
  #   patterns:
  #   - name: meta.function.def-func.opsi-script
  #     begin: (?i)^\s*(DefFunc)\s+(\S+)
  #     beginCaptures:
  #       '1': {name: storage.type.function.opsi-script}
  #       '2': {name: entity.name.function.opsi-script}
  #     end: (?i)^\s*(EndFunc)
  #     endCaptures:
  #       '1': {name: storage.type.function.opsi-script}
  #     patterns:
  #     - include: '#function'

  # function:
  #   patterns:
  #   - include: '#primary-sections'
  #   - include: '#secondary-sections'
  #   - include: '#primary-section'
  #   - include: '#function-definition'

  primary-section:
    patterns:
    - include: '#comments'
    - include: '#expressions'
    #- include: '#function-definition'
    - include: '#sub-section-calls'
    - include: '#secondary-section-calls'
    - include: '#primary-section-functions'
    - include: '#function-calls'

  primary-sections:
    patterns:
    - name: meta.primary-section.initial.opsi-script
      begin: (?i)^\s*(\[)(Initial)(\])
      beginCaptures:
        '2': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\s*\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.actions.opsi-script
      begin: (?i)^(\s*)(\[)(Actions|Aktionen)(\])
      beginCaptures:
        '3': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\1\[.*\]$)
      patterns:
      - include: '#primary-section'
      - include: '#primary-sections'
      - include: '#secondary-sections'
    - name: meta.primary-section.sub.opsi-script
      begin: (?i)^\s*(\[)(Sub\S+)(\])
      beginCaptures:
        '2': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\s*\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.profile-actions.opsi-script
      begin: (?i)^(\s*)(\[)(ProfileActions)(\])
      beginCaptures:
        '2': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\1\[.*\]$)
      patterns:
      - include: '#primary-section'
      - include: '#primary-sections'
      - include: '#secondary-sections'

  primary-section-functions:
    patterns:
     - include: '#primary-section-function-shellcall'
     - include: '#primary-section-function-powershellcall'
     - include: '#primary-section-function-registry'
     - name: invalid.deprecated.opsi-script
       match: (?i)\b(LogLevel|errorsOccuredSinceMark)\b
     - name: support.function.sub-call.opsi-script
       match: (?i)\b(Sub)\b
     - name: support.function.constants.opsi-script
       match: (?i)\b(replaceOpsiConstants)\b
     - name: support.variable.other.opsi-script
       match: (?i)\b(requiredWinstVersion|AutoActivityDisplay)\b
     - name: support.function.other.opsi-script
       match: (?i)\b(ExitWindows|noUpdateScript)\b
    # 2.4. By Topic
     - name: support.function.compare.opsi-script
       match: (?i)\b(CompareDotSeparatedStrings|CompareDotSeparatedStrings|CompareDotSeparatedNumbers|CompareDotSeparatedNumbers|boolToString|stringToBool)\b
     - name: support.function.crypt.opsi-script
       match: (?i)\b(DecStrToHexStr|HexStrToDecStr|base64EncodeStr|base64DecodeStr|RandomStr|RandomIntStr|encryptStringBlow|decryptStringBlow|md5sumFromFile)\b
     - name: support.function.import-lib.opsi-script
       match: (?i)\b(ImportLib)\b
     - name: storage.type.function.def-func.opsi-script
       match: (?i)\b(DefFunc|EndFunc)\b
     - name: support.variable.encoding.opsi-script
       match: (?i)\b(encoding)\b
     - name: support.function.encoding.opsi-script
       match: (?i)\b(GetLocaleInfoMap|ReEncodeStr|ReEncodeStrList|fileHasBom|loadUnicodeTextFile|loadTextFileWithEncoding|strLoadTextFileWithEncoding|saveTextFileWithEncoding|includelog)\b
     - name: support.variable.error.opsi-script
       match: (?i)\b(ExitOnError|ScriptErrorMessages|FatalOnSyntaxError|FatalOnRuntimeError)\b
     - name: support.function.error.opsi-script
       match: (?i)\b(isFatalError|isSuccess|isSuspended|markErrorNumber|errorsOccurredSinceMark|getLastServiceErrorClass|getLastServiceErrorMessage)\b
     - name: support.function.file-handling.opsi-script
       match: (?i)\b(strLoadTextFile|strLoadTextFileWithEncoding|loadTextFile|loadUnicodeTextFile|loadTextFileWithEncoding|fileHasBom|FileExists|FileExists32|FileExists64|FileExistsSysNative|FileOrFolderExists|listFiles|DirectoryExists|LineExistsIn|LineBeginning_ExistsIn|LineContaining_ExistsIn|saveTextFile|saveTextFileWithEncoding|getFileInfoMap|getFileInfoMap32|getFileInfoMap64|getFileInfoMapSysnative|ExtractFilePath|ExtractFileExtension|ExtractFileName)\b
     - name: support.function.ini-file.opsi-script
       match: (?i)\b(GetValueFromInifile|GetValueFromInifile|getSectionNames|GetSectionFromInifile|getValue|getValueBySeparator|getValueFromFile|getValueFromFileBySeparator)\b
     - name: support.function.interaction.opsi-script
       match: (?i)\b(Pause|Stop|setActionProgress|Message|ShowMessageFile|ShowBitMap|stringinput|editmap)\b
     - name: support.function.license-management.opsi-script
       match: (?i)\b(DemandLicenseKey|FreeLicense|opsiLicenseManagementEnabled)\b
     - name: support.function.system-linux.opsi-script
       match: (?i)\b(getLinuxDistroType|getLinuxVersionMap|cleanupPackageSystem|installupdates|debinstall|redinstall|suseinstall|ucsinstall|genericLinInstall|linuxInstallOneOf|isOneInstalled|linuxInstallOneFile|linuxRemoveOnePackage|linuxRemoveOneOf)\b
     - name: support.variable.logging.opsi-script
       match: (?i)\b(SetLogLevel|forceLogInAppendMode)\b
     - name: support.function.logging.opsi-script
       match: (?i)\b(Message|comment|LogError|LogWarning|includelog|SetConfidential|asConfidential)\b
     - name: support.function.system-macos.opsi-script
       match: (?i)\b(getMacosVersionInfo|getMacosVersionMap|install_macos_app|install_macos_pkg|install_macos_dmg|install_macos_zip|install_macos_generic)\b
     - name: support.function.network.opsi-script
       match: (?i)\b(GetHostsName|GetHostsAddr|GetMyIpByTarget|GetIpByName|isValidIP4|isValidIP4Network|isValidIP4Host|getIP4NetworkByAdrAndMask|getDefaultNetmaskByIP4adr|parseUrl|createUrl|isPingReachable|isValidFQDN)\b
     - name: support.function.numeric.opsi-script
       match: (?i)\b(isNumber|CompareDotSeparatedNumbers|CompareDotSeparatedNumbers|calculate|DecStrToHexStr|HexStrToDecStr|RandomIntStr)\b
     - name: support.function.system.opsi-script
       match: (?i)\b(GetOS|GetMsVersionInfo|GetMSVersionMap|getLinuxDistroType|getLinuxVersionMap|getMacosVersionInfo|getMacosVersionMap|GetSystemType|getOSArchitecture|getListFromWMI|EnvVar|getProfilesDirList|listFiles|runningAsAdmin|runningOnUefi|runningInPE|isDriveReady|runningWithGui)\b
     - name: support.function.json.opsi-script
       match: (?i)\b(jsonIsValid|jsonIsArray|jsonIsObject|jsonAsObjectHasKey|jsonAsArrayCountElements|jsonAsObjectCountElements|jsonAsArrayGetElementByIndex|jsonAsObjectGetValueByKey|jsonAsObjectSetValueByKey|jsonAsObjectSetStringtypeValueByKey|jsonAsObjectDeleteByKey|jsonAsArrayPutObjectByIndex|jsonAsArrayDeleteObjectByIndex|jsonAsArrayToStringList|jsonAsObjectGetKeyList|jsonStringListToJsonArray|convert2Jsonstr)\b
     - name: support.function.opsi.opsi-script
       match: (?i)\b(getProductMap|LoadProductProperties|getProductPropertyList|GetProductProperty|GetConfidentialProductProperty|setActionProgress|retrieveSection|replaceOpsiConstants|replaceOpsiConstants|runningInWanMode)\b
     - name: support.function.subprocess.opsi-script
       match: (?i)\b(Killtask|ChangeDirectory|GetProcessList|processIsRunning|getOutStreamFromSection|processCall|getLastExitCode|waitForPackageLock|which|executeSection)\b
     - name: support.function.regex.opsi-script
       match: (?i)\b(isRegexMatch|getSubListByContainingRegex|getRegexMatchList|removeFromListByContainingRegex|stringReplaceRegex|stringReplaceRegexInList)\b
     - name: support.function.win-registry.opsi-script
       match: (?i)\b(getRegistryValue|GetRegistryStringValue|GetRegistryStringValue32|GetRegistryStringValue64|GetRegistryStringValueSysNative|getRegistryKeyList32|getRegistryKeyList64|getRegistryKeyListSysnative|getRegistryVarList32|getRegistryVarList64|getRegistryVarListSysnative|getRegistryVarMap32|getRegistryVarMap64|getRegistryVarMapSysnative|RegKeyExists|RegVarExists)\b
     - name: support.function.string-handling.opsi-script
       match: (?i)\b(splitString|splitStringOnWhiteSpace|getIndexFromListByContaining|contains|isNumber|trim|lower|upper|unquote|unquote2|stringReplace|strLength|strPos|strPart|getValue|getValueBySeparator|getValueFromFile|getValueFromFileBySeparator|EscapeString)\b
     - name: support.function.stringlist-handling.opsi-script
       match: (?i)\b(GetReturnListFromSection|getListContaining|getListContainingList|getIndexFromListByContaining|count|emptylist|composeString|createStringList|reverse|getSubList|getSubListByMatch|getSubListByContaining|getSubListByKey|getKeyList|addtolist|addListToList|reencodestrlist|removeFromListByContaining|removeFromListByMatch|takeString|takeFirstStringContaining|setStringInListAtIndex|getValue|areListsEqual)\b
     - name: support.function.time.opsi-script
       match: (?i)\b(sleepSeconds|markTime|getDiffTimeSec|timeStampAsFloatStr)\b
     - name: support.function.usercontext.opsi-script
       match: (?i)\b(GetUserSID|GetLoggedInUser|GetUsercontext|GetScriptMode|saveVersionToProfile|readVersionFromProfile|scriptWasExecutedBefore)\b
     - name: support.function.xml.opsi-script
       match: (?i)\b(getXml2DocumentFromFile|getXml2Document|xml2GetFirstChildNodeByName|getXml2UniqueChildnodeByName|getXml2AttributeValueByKey|getXml2Text)\b

  primary-section-function-shellcall:
    patterns:
    - name: meta.function.shellcall.opsi-script
      match: (?i)\b(shellCall)\s*\(\s*(["'].*["'])\s*\)
      captures:
        '1': {name: support.function.shellcall.opsi-script}
        '2':
          name: meta.embedded.block.shellscript
          patterns:
          - include: '#primary-section-string'
          #- include: '#literal-constant'
          #- include: '#literal-variable'
          #- include: source.shell

  primary-section-function-powershellcall:
    patterns:
    - name: meta.function.powershellcall.opsi-script
      match: (?i)\b(powershellcall)\s*\(\s*(["'].*["'])\s*\)
      captures:
        '1': {name: support.function.powershell.opsi-script}
        '2':
          name: meta.embedded.block.powershell
          patterns:
          - include: '#primary-section-string'
          #- include: '#literal-constant'
          #- include: '#literal-variable'
          #- include: source.powershell

  primary-section-function-registry:
    patterns:
    - name: meta.function.registry.opsi-script
      match: (?i)\b(Registry)\b\s+(loadUnicodeTextFile)\(([^\)]+)\)\s+(/regedit|/addreg)\s*(\S*.*)
      captures:
        '1': {name: support.function.registry.opsi-script}
        '2': {name: support.function.load-unicode-text-file.opsi-script}
        '3':
          name: meta.function.registry.filename.opsi-script
          patterns:
          - include: '#primary-section-string'
        '4':
          name: constant.character.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '5': {name: invalid.illegal.arguments.opsi-script}

  primary-section-keyword-storage:
    patterns:
    - name: storage.type.opsi-script
      match: (?i)\b(DefVar|DefStringList|Set)\b

  primary-section-keywords:
    patterns:
    - include: '#primary-section-keyword-storage'
    - name: keyword.control.opsi-script
      match: (?i)\b(if|else|endif|for|in|do|Switch|EndSwitch|Case|EndCase)\b

  primary-section-operators:
    patterns:
    - name: keyword.operator.wordlike.opsi-script
      match: \b(and|or|not)\b

  primary-section-string:
    patterns:
    - name: string.quoted.single.primary-section-string.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'

    - name: string.quoted.double.primary-section-string.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
    - include: '#literal-constant'
    - include: '#literal-variable'

  primary-section-number:
    patterns:
    - name: constant.numeric.opsi-script
      match: (?xi)\b[0-9]+

  secondary-section-param-winst:
    patterns:
    - name: constant.character.param.winst.opsi-script
      match: (?i)\bwinst\b

  secondary-section-param-let-them-go:
    patterns:
    - name: constant.character.param.let-them-go.opsi-script
      match: (?i)\/LetThemGo\b

  secondary-section-param-timeout-seconds:
    patterns:
    - name: constant.character.param.timeout-seconds.opsi-script
      match: (?i)\/TimeOutSeconds\b\s+\d+

  secondary-section-param-wait-for-process-ending:
    patterns:
    - name: meta.param.wait-for-process-ending.opsi-script
      match: (?i)(/WaitForProcessEnding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.wait-for-process-ending.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-param-wait-for-window-appearing:
    patterns:
    - name: constant.character.param.wait-for-window-appearing.opsi-script
      match: (?i)(/WaitForWindowAppearing)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.wait-for-window-appearing.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-param-wait-for-window-vanish:
    patterns:
    - name: constant.character.param.wait-for-window-vanish.opsi-script
      match: (?i)(/WaitForWindowVanish)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.wait-for-window-vanish.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-param-run-elevated:
    patterns:
    - name: constant.character.param.run-elevated.opsi-script
      match: (?i)\/RunElevated\b

  secondary-section-param-run-as-logged-on-user:
    patterns:
    - name: constant.character.param.run-as-logged-on-user.opsi-script
      match: (?i)\/RunAsLoggedOnUser\b

  secondary-section-param-architecture:
    patterns:
    - name: constant.character.param.32bit.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b

  secondary-section-param-show-output:
    patterns:
    - name: constant.character.param.show-output.opsi-script
      match: (?i)\/ShowOutput\b

  secondary-section-param-escape-strings:
    patterns:
    - name: constant.character.param.escape-strings.opsi-script
      match: (?i)\/EscapeStrings\b

  secondary-section-param-all-nt-user-profiles:
    patterns:
    - name: constant.character.param.all-nt-user-profiles.opsi-script
      match: (?i)\/AllNTUserProfiles\b

  secondary-section-param-all-nt-user-send-to:
    patterns:
    - name: constant.character.param.all-nt-user-send-to.opsi-script
      match: (?i)\/AllNTUserSendTo\b

  secondary-section-param-all-nt-user-dats:
    patterns:
    - name: constant.character.param.all-nt-user-dats.opsi-script
      match: (?i)\/AllNTUserDats\b

  secondary-section-param-encoding:
    patterns:
    - name: constant.character.param.encoding.opsi-script
      match: (?i)\/encoding\b\s\S+

  secondary-section-params-win-batch:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-architecture"
    - include: "#secondary-section-param-timeout-seconds"
    - include: "#secondary-section-param-run-elevated"
    - include: "#secondary-section-param-wait-for-process-ending"
    - include: "#secondary-section-param-wait-for-window-appearing"
    - include: "#secondary-section-param-wait-for-window-vanish"
    - include: "#secondary-section-param-let-them-go"
    - include: "#secondary-section-param-run-as-logged-on-user"

  secondary-section-params-shell-batch:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-architecture"
    - include: "#secondary-section-param-timeout-seconds"
    - include: "#secondary-section-param-run-elevated"
    - include: "#secondary-section-param-wait-for-process-ending"
    - include: "#secondary-section-param-show-output"

  secondary-section-params-exec-with:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-architecture"
    - include: "#secondary-section-param-let-them-go"
    - include: "#secondary-section-param-escape-strings"

  secondary-section-params-files:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-architecture"
    - include: "#secondary-section-param-all-nt-user-profiles"
    - include: "#secondary-section-param-all-nt-user-send-to"

  secondary-section-params-registry:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-architecture"
    - include: "#secondary-section-param-all-nt-user-dats"

  secondary-section-params-patches:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-all-nt-user-profiles"

  secondary-section-params-patch-text-file:
    patterns:
    - include: "#secondary-section-param-winst"
    - include: "#secondary-section-param-all-nt-user-profiles"
    - include: "#secondary-section-param-encoding"

  function-calls:
    patterns:
    - name: meta.function-call.opsi-script
      match: (?i)\b(\S+)\([^\)]*\)
      captures:
        '1': {name: entity.name.type.function-call.opsi-script}

  sub-section-calls:
    patterns:
    - name: meta.sub-section-call.opsi-script
      match: (?i)\b(Sub\S+)\b
      captures:
        '1': {name: entity.name.type.sub-section-call.opsi-script}

  secondary-section-calls:
    patterns:
    - name: meta.secondary-section-call.win-batch.opsi-script
      match: (?i)\b(Winbatch\S+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.win-batch.params.opsi-script
          patterns:
          - include: '#secondary-section-params-win-batch'

    - name: meta.secondary-section-call.shell-batch.opsi-script
      match: (?i)\b(ShellBatch\S+|ShellInAnIcon\S+|DosBatch\S+|DosInAnIcon\S+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.shell-batch.params.opsi-script
          patterns:
          - include: '#secondary-section-params-shell-batch'

    - name: meta.secondary-section-call.exec-with.opsi-script
      match: (?i)\b(ExecWith\S+)\b\s*(["']?.*["']?)\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.exec-with.interpreter.opsi-script
          patterns:
          - include: '#primary-section-string'
        '3':
          name: meta.secondary-section-call.exec-with.params.opsi-script
          patterns:
          - include: '#secondary-section-params-exec-with'

    - name: meta.secondary-section-call.files.opsi-script
      match: (?i)\b(Files\S+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.files.params.opsi-script
          patterns:
          - include: '#secondary-section-params-files'

    - name: meta.secondary-section-call.registry.opsi-script
      match: (?i)\b(Registry\S+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.registry.params.opsi-script
          patterns:
          - include: '#secondary-section-params-registry'

    - name: meta.secondary-section-call.patches.opsi-script
      match: (?i)\b(Patches\S+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.patches.params.opsi-script
          patterns:
          - include: '#secondary-section-params-patches'

    - name: meta.secondary-section-call.patch-text-file.opsi-script
      match: (?i)\b(PatchTextFile\S+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.patch-text-file.params.opsi-script
          patterns:
          - include: '#secondary-section-params-patch-text-file'

    - name: meta.secondary-section-call.link-folder.opsi-script
      match: (?i)\b(LinkFolder\S+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.opsi-service-call.opsi-script
      match: (?i)\b(OpsiServiceCall\S+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.patch-hosts.opsi-script
      match: (?i)\b(PatchHosts\S+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.xml2.opsi-script
      match: (?i)\b(XML2\S+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.xml-patch.opsi-script
      match: (?i)\b(XMLPatch\S+)\b
      captures:
        '1': {name: invalid.deprecated.opsi-script}

    - name: meta.secondary-section-call.exec-python.opsi-script
      match: (?i)\b(ExecPython\S+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.ldap-search.opsi-script
      match: (?i)\b(LDAPSearch\S+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

  secondary-sections:
    patterns:

    - name: meta.secondary-section.shell-batch.opsi-script
      begin: (?i)^\s*(\[)(ShellBatch[^\]]+|ShellInAnIcon[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-shell-batch.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      contentName: meta.embedded.block.shellscript
      patterns:
      - include: '#secondary-section'
      - include: source.shell

    - name: meta.secondary-section.dos-batch.opsi-script
      begin: (?i)^\s*(\[)(DosBatch[^\]]+|DosInAnIcon[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-dos-batch.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      contentName: meta.embedded.block.dosbatch
      patterns:
      - include: '#secondary-section'
      - include: source.batchfile

    - name: meta.secondary-section.win-batch.opsi-script
      begin: (?i)^\s*(\[)(WinBatch[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-dos-batch.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.exec-with-powershell.opsi-script
      begin: (?i)^\s*(\[)(ExecWith[^\]]*powershell[^\]]*)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-exec-with-powershell.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      contentName: meta.embedded.block.powershell
      patterns:
      - include: '#secondary-section'
      - include: source.powershell

    - name: meta.secondary-section.exec-with-general.opsi-script
      begin: (?i)^\s*(\[)(ExecWith[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-exec-with-general.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      contentName: meta.embedded.block.general.opsi-script
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.files.opsi-script
      begin: (?i)^\s*(\[)(Files[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-files.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-files'

    - name: meta.secondary-section.registry.opsi-script
      begin: (?i)^\s*(\[)(Registry[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-registry.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-registry'

    - name: meta.secondary-section.patches.opsi-script
      begin: (?i)^\s*(\[)(Patches[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-patches.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patches'

    - name: meta.secondary-section.patch-text-file.opsi-script
      begin: (?i)^\s*(\[)(PatchTextFile[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-patch-text-file.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patch-text-file'

    - name: meta.secondary-section.link-folder.opsi-script
      begin: (?i)^\s*(\[)(LinkFolder[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-link-folder.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-link-folder'

    - name: meta.secondary-section.opsi-service-call.opsi-script
      begin: (?i)^\s*(\[)(OpsiServiceCall[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-opsi-service-call.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-opsi-service-call'

    - name: meta.secondary-section.patch-host.opsi-script
      begin: (?i)^\s*(\[)(PatchHost[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-patch-host.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patch-host'

    - name: meta.secondary-section.xml2.opsi-script
      begin: (?i)^\s*(\[)(XML2[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-xml2.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-xml2'

    - name: meta.secondary-section.exec-python.opsi-script
      begin: (?i)^\s*(\[)(ExecPython[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-exec-python.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      contentName: meta.embedded.block.python
      patterns:
      - include: '#secondary-section'
      - include: source.python

    - name: meta.secondary-section.ldap-search.opsi-script
      begin: (?i)^\s*(\[)(LDAPSearch[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-ldap-search.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|DefFunc|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-ldap-search'

  secondary-section:
    patterns:
    - include: '#comments'
    - include: '#secondary-section-string'
    - include: '#literal-constant'
    - include: '#literal-variable'

  secondary-section-string:
    patterns:
    - name: string.quoted.single.secondary-section-string.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
      - include: '#literal-variable'
    - include: '#literal-constant'
    - include: '#literal-variable'

    - name: string.quoted.double.secondary-section-string.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
      - include: '#literal-variable'

  secondary-section-files:
    patterns:

    - name: support.variable.secondary-section.files.opsi-script
      match: (?i)\b(SourcePath|checkTargetPath)\b

    - name: meta.function.secondary-section.files.copy.opsi-script
      match: \b((?i)copy)\b(\s+-[seVvduxwncrh]+)?\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.files.copy.opsi-script}
        '2': {name: constant.character.secondary-section.files.copy.arguments.opsi-script}
        '3':
          name: meta.secondary-section.files.copy.source.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '4':
          name: meta.secondary-section.files.copy.destination.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '5': {name: invalid.illegal.arguments.opsi-script}

    - name: meta.function.secondary-section.files.delete.opsi-script
      match: \b((?i)Del(?:ete)?)\b(\s+-(?:s|f|c|d\d*)+)?\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.files.delete.opsi-script}
        '2': {name: constant.character.secondary-section.files.delete.arguments.opsi-script}
        '3':
          name: meta.secondary-section.files.delete.path.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '4': {name: invalid.illegal.arguments.opsi-script}

    - name: meta.function.secondary-section.files.chmod.opsi-script
      match: \b((?i)chmod)\b\s+([0-8]{3,4})\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.files.chmod.opsi-script}
        '2': {name: constant.character.secondary-section.files.chmod.mask.opsi-script}
        '3':
          name: meta.secondary-section.files.chmod.path.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '4': {name: invalid.illegal.arguments.opsi-script}

    - name: meta.function.secondary-section.files.link-move-zip.opsi-script
      match: (?i)\b(hardlink|symlink|rename|move|zipfile|unzipfile)\b\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.files.link-move-zip.opsi-script}
        '2':
          name: meta.secondary-section.files.link-move-zip.source.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '3':
          name: meta.secondary-section.files.link-move-zip.destination.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '4': {name: invalid.illegal.arguments.opsi-script}

  secondary-section-registry-constants:
    patterns:
    - name: constant.language.registry-type.opsi-script
      match: '(?i)\b(REG_SZ|REG_EXPAND_SZ|REG_DWORD|REG_BINARY|REG_MULTI_SZ)'

  secondary-section-registry:
    patterns:
    - include: '#secondary-section-registry-constants'

    - name: meta.function.secondary-section.registry.flush-key.opsi-script
      match: (?i)\b(FlushKey)\b
      captures:
        '1': {name: support.function.secondary-section.registry.flush-key.opsi-script}

    - name: meta.function.secondary-section.registry.open-delete-key.opsi-script
      match: (?i)\b(OpenKey|DeleteKey)\b\s+\[([^\]]+)\]\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.registry.open-delete-key.opsi-script}
        '2':
          name: meta.secondary-section.registry.open-delete-key.key.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '3': {name: invalid.illegal.arguments.opsi-script}

    - name: meta.function.secondary-section.registry.set-add.opsi-script
      match: '(?i)\b(Set|Add)\b\s+(\"[^"]*\")\s+=\s+(?:(REG_SZ|REG_EXPAND_SZ|REG_DWORD|REG_BINARY|REG_MULTI_SZ)\s*:)?\s*(.*)'
      captures:
        '1': {name: support.function.secondary-section.registry.set-add.opsi-script}
        '2':
          name: meta.secondary-section.registry.set-add.key.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '3': {name: constant.character.secondary-section.registry.set-add.type.opsi-script}
        '4':
          name: meta.secondary-section.registry.set-add.value.opsi-script
          patterns:
          - include: '#secondary-section-string'

    - name: meta.function.secondary-section.registry.delete-var.opsi-script
      match: (?i)\b(DeleteVar)\b\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.registry.delete-var.opsi-script}
        '2':
          name: meta.secondary-section.registry.delete-var.name.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '3': {name: invalid.illegal.arguments.opsi-script}

    - name: meta.function.secondary-section.registry.supp.opsi-script
      match: (?i)\b(Supp)\b\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s+(\S)\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.registry.supp.opsi-script}
        '2':
          name: meta.secondary-section.registry.supp.varname.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '3': {name: constant.character.opsi-script}
        '4':
          name: meta.secondary-section.registry.supp.supplement.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '5': {name: invalid.illegal.arguments.opsi-script}

    - name: meta.function.secondary-section.registry.file.opsi-script
      match: (?i)\b(GetMultiSZFromFile|SaveValueToFile)\b\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s+("(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*)\s*(\S*.*)
      captures:
        '1': {name: support.function.secondary-section.registry.file.opsi-script}
        '2':
          name: meta.secondary-section.registry.file.varname.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '3':
          name: meta.secondary-section.registry.file.filename.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '4': {name: invalid.illegal.arguments.opsi-script}

  secondary-section-patches:
    patterns:
    - name: support.function.secondary-section.patches.opsi-script
      match: (?i)\b(Add|Set|AddNew|Del|DelSec|Replace)\b

  secondary-section-patch-text-file-constants:
    patterns:
    - name: constant.language.secondary-section.patch-text-file.mozilla-preference-types.opsi-script
      match: '(?i)\b(pref|user_pref|lock_pref|lockPref)'

  secondary-section-patch-text-file:
    patterns:
    - include: "#secondary-section-patch-text-file-constants"

    - name: support.function.secondary-section.patch-text-file.mozilla.opsi-script
      match: (?i)\b(AddStringListElement_To_Mozilla_Pref|Set_Netscape_User_Pref|AddstringListElement_To_Netscape_User_Pref)\b

    - name: support.function.secondary-section.patch-text-file.opsi-script
      match: (?i)\b(FindLine|FindLine_StartingWith|FindLine_Containing|GoToTop|AdvanceLine|GoToBottom|DeleteTheLine|AddLine_|Add_Line_|InsertLine|AppendLine|Append_Line|Append_File|Subtract_File|SaveToFile|Sorted|setKeyValueSeparator|setValueByKey)\b

  secondary-section-link-folder-constants:
    patterns:
    - name: constant.language.secondary-section.link-folder.predefined-virtual-system-folders-windows.opsi-script
      match: '(?i)\b(desktop|sendto|startmenu|startup|programs|desktopdirectory|common_startmenu|common_programs|common_startup|common_desktopdirectory)'
    - name: constant.language.secondary-section.link-folder.predefined-virtual-system-folders-linux.opsi-script
      match: '(?i)\b(common_programs|common_startup|desktop|startup)'
    - name: constant.language.secondary-section.link-folder.predefined-link-categories-linux.opsi-script
      match: '(?i)\b(AudioVideo|Audio|Video|Development|Education|Game|Graphics|Network|Office|Settings|System|Utility)'

  secondary-section-link-folder-attributes:
    patterns:
    - name: keyword.other.secondary-section.link-folder.link-attributes.opsi-script
      match: (?i)\b(name|target|parameters|working_dir|icon_file|icon_index|shortcut|link_categories)\b

  secondary-section-link-folder:
    patterns:
    - include: '#secondary-section-link-folder-constants'
    - include: '#secondary-section-link-folder-attributes'

    - name: support.function.secondary-section.link-folder.opsi-script
      match: (?i)\b(set_basefolder|set_subfolder|set_link|end_link|delete_element|delete_subfolder)\b

  secondary-section-opsi-service-call-constants:
    patterns:
    - name: constant.language.secondary-section.opsi-service-call.opsi-script
      match: '(?i)\b("method":|"params":)'

  secondary-section-opsi-service-call:
    patterns:
      - include: "#secondary-section-opsi-service-call-constants"

  secondary-section-patch-host:
    patterns:
    - name: support.function.secondary-section.patch-host.opsi-script
      match: (?i)\b(SetAddr|SetName|SetAlias|DelAlias|DelHost|SetComment)\b

  secondary-section-xml2-constants:
    patterns:
    - name: constant.language.secondary-section.xml2.opsi-script
      match: '(?i)\b(true|false)'

  secondary-section-xml2:
    patterns:
    - include: "#secondary-section-xml2-constants"

    - name: support.variable.secondary-section.xml2.opsi-script
      match: (?i)\b(strictMode)\b

    - name: support.function.secondary-section.xml2.opsi-script
      match: (?i)\b(OpenNode|SetAttribute|AddAttribute|DeleteAttribute|AddNewNode|SetNodeText|DeleteNode|GotoParentNode)\b

  secondary-section-ldap-search-keywords:
    patterns:
    - name: keyword.other.secondary-section.ldap-search.opsi-script
      match: '(?i)\b(targethost|targetport|user|password|dn|attributes|filter)'

  secondary-section-ldap-search:
    patterns:
    - include: "#secondary-section-ldap-search-keywords"

patterns:
  - include: '#core'
