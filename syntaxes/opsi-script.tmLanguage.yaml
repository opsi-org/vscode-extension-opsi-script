# https://code.visualstudio.com/api/language-extensions/syntax-highlight-guide
# https://www.apeth.com/nonblog/stories/textmatebundle.html
# https://github.com/microsoft/vscode/tree/main/extensions/markdown-basics
#
# npx js-yaml syntaxes/opsi-script.tmLanguage.yaml > syntaxes/opsi-script.tmLanguage.json

scopeName: source.opsi-script
name: opsi-script
uuid: 08cd1012-1f35-44bf-a64a-ebf3f82c8978
fileTypes: [.opsiscript, .ins]
#foldingStartMarker: ^\[[^\]]+\]
#foldingStopMarker: ^\[[^\]]+\]

repository:
  core:
    patterns:
    - include: '#comments'
    - include: '#primary-sections'
    - include: '#secondary-sections'

  expressions:
    patterns:
    - include: '#brackets'
    - include: '#primary-section-keywords'
    - include: '#primary-section-operators'
    - include: '#primary-section-number'
    - include: '#primary-section-string'
    - include: '#literal-constant'
    - include: '#literal-variable'

  comments:
    patterns:
    - name: comment.line.semicolon.opsi-script
      match: ^(;).*$\n?
      captures:
        '1': {name: punctuation.definition.comment.opsi-script}

  brackets:
    patterns:
    - include: '#round-brackets'

  round-brackets:
    patterns:
    - name: meta.group.braces.round
      begin: \(
      beginCaptures:
        '0': {name: meta.brace.round.opsi-script}
      end: \)
      endCaptures:
        '0': {name: meta.brace.round.opsi-script}
      patterns:
      - include: '#expressions'
      - include: '#primary-section-functions'

  literal-constant:
    patterns:
    - name: constant.language.builtin.win-system-directories.opsi-script
      match: '(?i)(%)(ProgramFilesDir|ProgramFiles32Dir|ProgramFiles64Dir|ProgramFilesSysnativeDir|Systemroot|System|Systemdrive|ProfileDir)(%)'
      #captures:
      #  '1': {name: punctuation.percent.opsi-script}
      #  '2': {name: punctuation.percent.opsi-script}
    - name: constant.language.builtin.win-common-user.opsi-script
      match: '(?i)(%)(AllUsersProfileDir|CommonProfileDir|CommonStartMenuPath|CommonStartmenuDir|CommonAppdataDir|CommonDesktopDir|CommonStartupDir|CommonProgramsDir)(%)'
    - name: constant.language.builtin.win-default-user.opsi-script
      match: '(?i)(%)(DefaultUserProfileDir)(%)'
    - name: constant.language.builtin.win-current-user.opsi-script
      match: '(?i)(%)(AppdataDir|CurrentAppdataDir|CurrentStartmenuDir|CurrentDesktopDir|CurrentStartupDir|CurrentProgramsDir|CurrentSendToDir|CurrentProfileDir)(%)'
    - name: constant.language.builtin.win-all-nt-user-profiles.opsi-script
      match: '(?i)(%)(UserProfileDir|CurrentProfileDir)(%)'
    - name: constant.language.builtin.win-all-nt-user-profiles.opsi-script
      match: '(?i)(%)(UserProfileDir|CurrentProfileDir)(%)'
    - name: constant.language.builtin.opsi-script-path.opsi-script
      match: '(?i)(%)(ScriptPath|ScriptDir|ScriptDrive|OpsiscriptDir|WinstDir|OpsiscriptVersion|WinstVersion|Logfile|opsiScriptHelperPath|opsiTmpDir|opsiLogDir|opsidata|opsiapplog)(%)'
    - name: constant.language.builtin.network-info.opsi-script
      match: '(?i)(%)(Host|PCName|Username|IPName|IPAddress)(%)'
    - name: constant.language.builtin.service-data.opsi-script
      match: '(?i)(%)(HostID|opsiserviceURL|opsiServer|opsiDepotId|opsiserviceUser|opsiservicePassword|installingProdName|installingProdVersion|installingProduct)(%)'


  literal-variable:
    patterns:
    - name: variable.other.dollar.opsi-script
      match: '(\$)[$\w]+(\$)'
      captures:
        '1': {name: punctuation.dollar.opsi-script}
        '2': {name: punctuation.dollar.opsi-script}

  primary-section:
    patterns:
    - include: '#comments'
    - include: '#expressions'
    - include: '#secondary-section-calls'
    - include: '#primary-section-functions'

  primary-sections:
    patterns:
    - name: meta.primary-section.initial.opsi-script
      begin: (?i)^(\[)(Initial)(\])
      beginCaptures:
        '2': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.actions.opsi-script
      begin: (?i)^(\[)(Actions|Aktionen)(\])
      beginCaptures:
        #'1': {name: keyword.other.section-bracket-open.opsi-script}
        #'2': {name: entity.name.function.opsi-script}
        '2': {name: entity.name.type.primary-section.opsi-script}
        #'3': {name: keyword.other.section-bracket-close.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.sub.opsi-script
      begin: (?i)^(\[)(Sub\S+)(\])
      beginCaptures:
        '2': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.profile-actions.opsi-script
      begin: (?i)^(\[)(ProfileActions)(\])
      beginCaptures:
        '2': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#primary-section'

  primary-section-functions:
    patterns:
     - include: '#primary-section-function-shellcall'
     - include: '#primary-section-function-powershellcall'
     - name: invalid.deprecated.opsi-script
       match: (?i)\b(LogLevel)\b
     - name: support.function.builtin.sub-call.opsi-script
       match: (?i)\b(Sub)\b
     - name: support.function.builtin.constants.opsi-script
       match: (?i)\b(replaceOpsiConstants)\b
    # TODO: chmod in Files_
    # 2.4. By Topic
     - name: support.function.builtin.compare.opsi-script
       match: (?i)\b(CompareDotSeparatedStrings|CompareDotSeparatedStrings|CompareDotSeparatedNumbers|CompareDotSeparatedNumbers|boolToString|stringToBool)\b
     - name: support.function.builtin.crypt.opsi-script
       match: (?i)\b(DecStrToHexStr|HexStrToDecStr|base64EncodeStr|base64DecodeStr|RandomStr|RandomIntStr|encryptStringBlow|decryptStringBlow|md5sumFromFile)\b
     - name: support.function.builtin.defined-functions.opsi-script
       match: (?i)\b(DefFunc|endfunc|importLib)\b
     - name: support.variable.builtin.encoding.opsi-script
       match: (?i)\b(encoding)\b
     - name: support.function.builtin.encoding.opsi-script
       match: (?i)\b(GetLocaleInfoMap|reencodestr|reencodestrlist|fileHasBom|loadUnicodeTextFile|loadTextFileWithEncoding|strLoadTextFileWithEncoding|saveTextFileWithEncoding|includelog)\b
     - name: support.variable.builtin.error.opsi-script
       match: (?i)\b(ExitOnError|ScriptErrorMessages|FatalOnSyntaxError|FatalOnRuntimeError)\b
     - name: support.function.builtin.error.opsi-script
       match: (?i)\b(isFatalError|markErrorNumber|errorsOccurredSinceMark|getLastServiceErrorClass|getLastServiceErrorMessage)\b
     - name: support.function.builtin.file-handling.opsi-script
       match: (?i)\b(strLoadTextFile|strLoadTextFileWithEncoding|loadTextFile|loadUnicodeTextFile|loadTextFileWithEncoding|fileHasBom|FileExists|FileExists32|FileExists64|FileExistsSysNative|FileOrFolderExists|listFiles|DirectoryExists|LineExistsIn|LineBeginning_ExistsIn|LineContaining_ExistsIn|saveTextFile|saveTextFileWithEncoding|getFileInfoMap|getFileInfoMap32|getFileInfoMap64|getFileInfoMapSysnative|ExtractFilePath|ExtractFileExtension|ExtractFileName)\b
     - name: support.function.builtin.ini-file.opsi-script
       match: (?i)\b(GetValueFromInifile|GetValueFromInifile|getSectionNames|GetSectionFromInifile|getValue|getValueBySeparator|getValueFromFile|getValueFromFileBySeparator)\b
     - name: support.function.builtin.interaction.opsi-script
       match: (?i)\b(Pause|Stop|setActionProgress|Message|ShowMessageFile|ShowBitMap|stringinput|editmap)\b
     - name: support.function.builtin.license-management.opsi-script
       match: (?i)\b(DemandLicenseKey|FreeLicense|opsiLicenseManagementEnabled)\b
     - name: support.function.builtin.system-linux.opsi-script
       match: (?i)\b(getLinuxDistroType|getLinuxVersionMap|cleanupPackageSystem|installupdates|debinstall|redinstall|suseinstall|ucsinstall|genericLinInstall|linuxInstallOneOf|isOneInstalled|linuxInstallOneFile|linuxRemoveOnePackage|linuxRemoveOneOf)\b
     - name: support.variable.builtin.logging.opsi-script
       match: (?i)\b(SetLogLevel|forceLogInAppendMode)\b
     - name: support.function.builtin.logging.opsi-script
       match: (?i)\b(Message|comment|LogError|LogWarning|includelog|SetConfidential|asConfidential)\b
     - name: support.function.builtin.system-macos.opsi-script
       match: (?i)\b(getMacosVersionInfo|getMacosVersionMap|install_macos_app|install_macos_pkg|install_macos_dmg|install_macos_zip|install_macos_generic)\b
     - name: support.function.builtin.network.opsi-script
       match: (?i)\b(GetHostsName|GetHostsAddr|GetMyIpByTarget|GetIpByName|isValidIP4|isValidIP4Network|isValidIP4Host|getIP4NetworkByAdrAndMask|getDefaultNetmaskByIP4adr|parseUrl|createUrl|isPingReachable|isValidFQDN)\b
     - name: support.function.builtin.numeric.opsi-script
       match: (?i)\b(isNumber|CompareDotSeparatedNumbers|CompareDotSeparatedNumbers|calculate|DecStrToHexStr|HexStrToDecStr|RandomIntStr)\b
     - name: support.function.builtin.system.opsi-script
       match: (?i)\b(GetOS|GetMsVersionInfo|GetMSVersionMap|getLinuxDistroType|getLinuxVersionMap|getMacosVersionInfo|getMacosVersionMap|GetSystemType|getOSArchitecture|getListFromWMI|EnvVar|getProfilesDirList|listFiles|runningAsAdmin|runningOnUefi|runningInPE|isDriveReady|runningWithGui)\b
     - name: support.function.builtin.json.opsi-script
       match: (?i)\b(jsonIsValid|jsonIsArray|jsonIsObject|jsonAsObjectHasKey|jsonAsArrayCountElements|jsonAsObjectCountElements|jsonAsArrayGetElementByIndex|jsonAsObjectGetValueByKey|jsonAsObjectSetValueByKey|jsonAsObjectSetStringtypeValueByKey|jsonAsObjectDeleteByKey|jsonAsArrayPutObjectByIndex|jsonAsArrayDeleteObjectByIndex|jsonAsArrayToStringList|jsonAsObjectGetKeyList|jsonStringListToJsonArray|convert2Jsonstr)\b
     - name: support.function.builtin.opsi.opsi-script
       match: (?i)\b(getProductMap|getProductPropertyList|GetProductProperty|GetConfidentialProductProperty|setActionProgress|retrieveSection|replaceOpsiConstants|replaceOpsiConstants|runningInWanMode)\b
     - name: support.function.builtin.subprocess.opsi-script
       match: (?i)\b(Killtask|ChangeDirectory|GetProcessList|processIsRunning|getOutStreamFromSection|processCall|getLastExitCode|waitForPackageLock|which|executeSection)\b
     - name: support.function.builtin.regex.opsi-script
       match: (?i)\b(isRegexMatch|getSubListByContainingRegex|getRegexMatchList|removeFromListByContainingRegex|stringReplaceRegex|stringReplaceRegexInList)\b
     - name: support.function.builtin.win-registry.opsi-script
       match: (?i)\b(getRegistryValue|GetRegistrystringvalue|GetRegistryStringValue32|GetRegistryStringValue64|GetRegistryStringValueSysNative|getRegistryKeyList32|getRegistryKeyList64|getRegistryKeyListSysnative|getRegistryVarList32|getRegistryVarList64|getRegistryVarListSysnative|getRegistryVarMap32|getRegistryVarMap64|getRegistryVarMapSysnative|RegKeyExists|RegVarExists)\b
     - name: support.function.builtin.string-handling.opsi-script
       match: (?i)\b(splitString|splitStringOnWhiteSpace|getIndexFromListByContaining|contains|isNumber|trim|lower|upper|unquote|unquote2|stringReplace|strLength|strPos|strPart|getValue|getValueBySeparator|getValueFromFile|getValueFromFileBySeparator|EscapeString)\b
     - name: support.function.builtin.stringlist-handling.opsi-script
       match: (?i)\b(getListContaining|getListContainingList|getIndexFromListByContaining|count|emptylist|composeString|createStringList|reverse|getSubList|getSubListByMatch|getSubListByContaining|getSubListByKey|getKeyList|addtolist|addListToList|reencodestrlist|removeFromListByContaining|removeFromListByMatch|takeString|takeFirstStringContaining|setStringInListAtIndex|getValue|areListsEqual)\b
     - name: support.function.builtin.time.opsi-script
       match: (?i)\b(sleepSeconds|markTime|getDiffTimeSec|timeStampAsFloatStr)\b
     - name: support.function.builtin.usercontext.opsi-script
       match: (?i)\b(GetUserSID|GetLoggedInUser|GetUsercontext|GetScriptMode|saveVersionToProfile|readVersionFromProfile|scriptWasExecutedBefore)\b
     - name: support.function.builtin.xml.opsi-script
       match: (?i)\b(getXml2DocumentFromFile|getXml2Document|xml2GetFirstChildNodeByName|getXml2UniqueChildnodeByName|getXml2AttributeValueByKey|getXml2Text)\b

  primary-section-function-shellcall:
    patterns:
    - name: meta.function.shellcall.opsi-script
      match: (?i)\b(shellCall)\s*\(\s*(["'])(.*)(["'])\s*\)
      captures:
        '1': {name: support.function.builtin.shellcall.opsi-script}
        '2': {name: punctuation.definition.string.begin.opsi-script}
        '3':
          name: meta.embedded.block.shellscript
          patterns:
          - include: '#literal-constant'
          - include: '#literal-variable'
          - include: source.shell
        '4': {name: punctuation.definition.string.end.opsi-script}

  primary-section-function-powershellcall:
    patterns:
    - name: meta.function.powershellcall.opsi-script
      match: (?i)\b(powershellcall)\s*\(\s*(["'])(.*)(["'])\s*\)
      captures:
        '1': {name: support.function.builtin.powershell.opsi-script}
        '2': {name: punctuation.definition.string.begin.opsi-script}
        '3':
          name: meta.embedded.block.powershell
          patterns:
          - include: '#literal-constant'
          - include: '#literal-variable'
          - include: source.powershell
        '4': {name: punctuation.definition.string.end.opsi-script}

  primary-section-keyword-storage:
    patterns:
    - name: storage.type.opsi-script
      match: (?i)(?<!\.)\b(DefVar|DefStringList|Set)\b

  primary-section-keywords:
    patterns:
    - include: '#primary-section-keyword-storage'
    - name: keyword.control.opsi-script
      match: (?i)\b(if|else|endif|for|in|do)\b

  primary-section-operators:
    patterns:
    - name: keyword.operator.wordlike.opsi-script
      match: \b(and|or|not)\b

  primary-section-string:
    patterns:
    - name: string.quoted.single.primary-section-string.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'

    - name: string.quoted.double.primary-section-string.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'

  primary-section-number:
    patterns:
    - name: constant.numeric.opsi-script
      match: (?xi)\b[0-9]+


  secondary-section-param-let-them-go:
    patterns:
    - name: constant.character.opsi-script
      match: (?i)\/LetThemGo\b

  secondary-section-param-timeout-seconds:
    patterns:
    - name: constant.character.param.timeout-seconds.opsi-script
      match: (?i)\/TimeOutSeconds\b\s+\d+

  secondary-section-param-wait-for-process-ending:
    patterns:
    - name: meta.param.wait-for-process-ending.opsi-script
      match: (?i)(/WaitForProcessEnding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.wait-for-process-ending.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-param-wait-for-window-appearing:
    patterns:
    - name: constant.character.param.wait-for-window-appearing.opsi-script
      match: (?i)(/WaitForWindowAppearing)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.wait-for-window-appearing.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-param-wait-for-window-vanish:
    patterns:
    - name: constant.character.param.wait-for-window-vanish.opsi-script
      match: (?i)(/WaitForWindowVanish)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.wait-for-window-vanish.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-param-run-elevated:
    patterns:
    - name: constant.character.param.run-elevated.opsi-script
      match: (?i)\/RunElevated\b

  secondary-section-param-run-as-logged-on-user:
    patterns:
    - name: constant.character.param.run-as-logged-on-user.opsi-script
      match: (?i)\/RunAsLoggedOnUser\b

  secondary-section-param-architecture:
    patterns:
    - name: constant.character.param.32bit.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b

  secondary-section-params-winbatch:
    patterns:
    - include: "#secondary-section-param-let-them-go"
    - include: "#secondary-section-param-wait-for-process-ending"
    - include: "#secondary-section-param-timeout-seconds"
    - include: "#secondary-section-param-wait-for-window-appearing"
    - include: "#secondary-section-param-wait-for-window-vanish"
    - include: "#secondary-section-param-run-elevated"
    - include: "#secondary-section-param-run-as-logged-on-user"
    - include: "#secondary-section-param-architecture"

  secondary-section-calls:
    patterns:
    - name: meta.secondary-section-call.without-arguments.opsi-script
      match: (?i)\b(ShellBatch\S+|ShellInAnIcon\S+|DosBatch\S+|DosInAnIcon\S+|ExecWith\S+|PatchTextFile\S+)\b
      captures:
        #'1': {name: entity.name.function.opsi-script}
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
    - name: meta.secondary-section-call.winbatch.opsi-script
      match: (?i)\b(Winbatch\S+)\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.winbatch.params
          patterns:
          - include: '#secondary-section-params-winbatch'

  secondary-sections:
    patterns:

    - name: meta.secondary-section.shell-batch.opsi-script
      begin: (?i)^(\[)(ShellBatch[^\]]+|ShellInAnIcon[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-shell-batch.opsi-script}
      while: ^(?!\[.*\]$)
      contentName: meta.embedded.block.shellscript
      patterns:
      - include: '#secondary-section'
      - include: source.shell

    - name: meta.secondary-section.dos-batch.opsi-script
      begin: (?i)^(\[)(DosBatch[^\]]+|DosInAnIcon[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-dos-batch.opsi-script}
      while: ^(?!\[.*\]$)
      contentName: meta.embedded.block.dosbatch
      patterns:
      - include: '#secondary-section'
      - include: source.batchfile

    - name: meta.secondary-section.exec-with-powershell.opsi-script
      begin: (?i)^(\[)(ExecWith[^\]]*powershell[^\]]*)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-exec-with-powershell.opsi-script}
      while: ^(?!\[.*\]$)
      contentName: meta.embedded.block.powershell
      patterns:
      - include: '#secondary-section'
      - include: source.powershell

    - name: meta.secondary-section.exec-with-general.opsi-script
      begin: (?i)^(\[)(ExecWith[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-exec-with-general.opsi-script}
      while: ^(?!\[.*\]$)
      contentName: meta.embedded.block.general
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.patch-text-file.opsi-script
      begin: (?i)^(\[)(PatchTextFile[^\]]+)(\])
      beginCaptures:
        '2': {name: entity.name.type.secondary-section-patch-text-file.opsi-script}
      while: ^(?!\[.*\]$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patch-text-file'

  secondary-section:
    patterns:
    - include: '#comments'
    - include: '#secondary-section-string'
    - include: '#literal-constant'
    - include: '#literal-variable'

  secondary-section-patch-text-file:
    patterns:
    - name: support.function.builtin.secondary-section.patchtextfile.opsi-script
      match: (?<!\.)(?i)\b(FindLine_Containing|DeleteTheLine|InsertLine)\b

  secondary-section-string:
    patterns:
    - name: string.quoted.single.secondary-section-string.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
      - include: '#literal-variable'

    - name: string.quoted.double.secondary-section-string.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant'
      - include: '#literal-variable'

patterns:
  - include: '#core'
