# Copyright (c) 2022 uib GmbH <info@uib.de>
# All rights reserved.
# License: AGPL-3.0

# https://code.visualstudio.com/api/language-extensions/syntax-highlight-guide
# https://www.apeth.com/nonblog/stories/textmatebundle.html
# https://github.com/microsoft/vscode/tree/main/extensions/markdown-basics
#
# npx js-yaml syntaxes/opsi-script.tmLanguage.yaml > syntaxes/opsi-script.tmLanguage.json
#
# "(?:(?:\\"|(?:(?!")).)*)"|'(?:(?:\\'|(?:(?!')).)*)'|[^"'\s]*
# matches:
#  "double quote (\") string"
#  'single quote (\') string'
#  string_without_quotes_and_whitespace


scopeName: source.opsi-script
name: opsi-script
uuid: 08cd1012-1f35-44bf-a64a-ebf3f82c8978
fileTypes: [.opsiscript, .opsiinc, .ins]
#foldingStartMarker: ^\[[^\]]+\]
#foldingStopMarker: ^\[[^\]]+\]

repository:
  core:
    patterns:
    - include: '#file-start'
    - include: '#comments'
    - include: '#primary-sections'
    - include: '#secondary-sections'

  expressions:
    patterns:
    - include: '#brackets'
    - include: '#primary-section-keywords'
    - include: '#primary-section-operators'
    - include: '#primary-section-number'
    - include: '#primary-section-string'
    - include: '#literal-variable'

  comments:
    patterns:
    - name: comment.line.semicolon-or-hash.opsi-script
      match: ^\s*(;).*$\n?
      captures:
        '1': {name: punctuation.definition.comment.opsi-script}

  brackets:
    patterns:
    - include: '#round-brackets'

  round-brackets:
    patterns:
    - name: meta.group.braces.round
      begin: \(
      beginCaptures:
        '0': {name: meta.brace.round.opsi-script}
      end: \)
      endCaptures:
        '0': {name: meta.brace.round.opsi-script}
      patterns:
      - include: '#expressions'
      - include: '#primary-section-functions'

  literal-constant-percent:
    patterns:
    # Since the user can define own constants in for-loops, we need a general constant-recognition.
    # But there are not enough effective colours to highlight script constants and general user constants differently,
    # therefore we don't need to put all script constants here.
    - name: invalid.deprecated.script-constants.opsi-script
      match: '(?i)(%)(WinstDir|WinstVersion|installingProduct|Host|IPAddress)(%)'
    - name: variable.other.percent.opsi-script
      match: '(%)\w+(%)'
      captures:
        '1': {name: punctuation.percent.opsi-script}
        '2': {name: punctuation.percent.opsi-script}

  literal-variable:
    patterns:
    - name: variable.other.dollar.opsi-script
      match: '(\$)\w+(\$)'
      captures:
        '1': {name: punctuation.dollar.opsi-script}
        '2': {name: punctuation.dollar.opsi-script}

  # function-definition:
  #   patterns:
  #   - name: meta.function.def-func.opsi-script
  #     begin: (?i)^\s*(DefFunc)\s+(\S+)
  #     beginCaptures:
  #       '1': {name: storage.type.function.opsi-script}
  #       '2': {name: entity.name.function.opsi-script}
  #     end: (?i)^\s*(EndFunc)
  #     endCaptures:
  #       '1': {name: storage.type.function.opsi-script}
  #     patterns:
  #     - include: '#function'

  # function:
  #   patterns:
  #   - include: '#primary-sections'
  #   - include: '#secondary-sections'
  #   - include: '#primary-section'
  #   - include: '#function-definition'

  file-start:
    patterns:
    - name: meta.primary-section.file-start.opsi-script
      begin: ^(?!\s*\[)
      while: ^(?!\s*\[.*\]$)
      patterns:
      - include: '#primary-section'
      - include: '#primary-sections'
      - include: '#secondary-sections'

  primary-section:
    patterns:
    - include: '#comments'
    - include: '#expressions'
    #- include: '#function-definition'
    - include: '#sub-section-calls'
    - include: '#secondary-section-calls'
    - include: '#primary-section-functions'
    - include: '#function-calls'

  primary-sections:
    patterns:
    - name: meta.primary-section.actions.opsi-script
      begin: (?i)^\s*\[(Aktionen|Initial)\]
      beginCaptures:
        '1': {name: invalid.deprecated.primary-section.opsi-script}
      while: ^(?!\1\[.*\]$)
      patterns:
      - include: '#primary-section'
      - include: '#primary-sections'
      - include: '#secondary-sections'
    - name: meta.primary-section.actions.opsi-script
      begin: (?i)^\s*\[(Actions)\]
      beginCaptures:
        '1': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\1\[.*\]$)
      patterns:
      - include: '#primary-section'
      - include: '#primary-sections'
      - include: '#secondary-sections'
    - name: meta.primary-section.sub.opsi-script
      begin: (?i)^\s*\[(Sub_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\s*\[.*\]$)
      patterns:
      - include: '#primary-section'
    - name: meta.primary-section.profile-actions.opsi-script
      begin: (?i)^\s*\[(ProfileActions)\]
      beginCaptures:
        '1': {name: entity.name.type.primary-section.opsi-script}
      while: ^(?!\1\[.*\]$)
      patterns:
      - include: '#primary-section'
      - include: '#primary-sections'
      - include: '#secondary-sections'

  primary-section-functions:
    patterns:
     - include: '#primary-section-function-registry'
     - name: invalid.deprecated.opsi-script
       match: (?i)\b(LogLevel|errorsOccuredSinceMark|IniVar|StringSplit|SubstringBefore|GetIni|getLocaleInfo|getntversion|on|off|GetRegistryStringValue|ExitWindows\s+/RebootWanted)\b
     - name: variable.other.opsi-script
       match: (?i)\b(encoding|ExitOnError|ScriptErrorMessages|FatalOnSyntaxError|FatalOnRuntimeError|SetLogLevel|SetDebug_Lib|forceLogInAppendMode|requiredOpsiscriptVersion|requiredWinstVersion|SetSkinDirectory|AutoActivityDisplay|TraceMode|StayOnTop|SetConfidential)\b
     - name: support.function.opsi-script
       match: (?i)\b(base64EncodeStr|base64DecodeStr|encryptStringBlow|decryptStringBlow|md5sumFromFile|hashFromFile|isCertInstalledInSystem|importCertToSystem|removeCertFromSystem|listCertificatesFromSystem|isFatalError|isSuccess|isSuspended|markErrorNumber|errorsOccurredSinceMark|strLoadTextFile|strLoadTextFileWithEncoding|loadTextFile|loadUnicodeTextFile|loadTextFileWithEncoding|fileHasBom|FileExists|FileExists32|FileExists64|FileExistsSysNative|DirectoryExists|FileOrFolderExists|fileIsSymlink|resolveSymlink|forcePathDelims|LineExistsIn|LineBeginning_ExistsIn|LineContaining_ExistsIn|saveTextFile|saveTextFileWithEncoding|getFileInfoMap|getFileInfoMap32|getFileInfoMap64|getFileInfoMapSysnative|ExtractFilePath|ExtractFileExtension|ExtractFileName|getValueFromFile|getValueFromFileBySeparator|GetValueFromInifile|getSectionNames|GetSectionFromInifile|jsonIsValid|jsonIsArray|jsonIsObject|jsonAsObjectHasKey|jsonAsArrayCountElements|jsonAsObjectCountElements|jsonAsArrayGetElementByIndex|jsonAsObjectGetValueByKey|jsonAsObjectSetValueByKey|jsonAsObjectSetStringtypeValueByKey|jsonAsObjectDeleteByKey|jsonAsArrayPutObjectByIndex|jsonAsArrayDeleteObjectByIndex|jsonAsArrayToStringList|jsonAsObjectGetKeyList|jsonStringListToJsonArray|convert2Jsonstr|DemandLicenseKey|FreeLicense|getLastServiceErrorClass|getLastServiceErrorMessage|opsiLicenseManagementEnabled|asConfidential|GetHostsName|GetHostsAddr|GetMyIpByTarget|GetIpByName|isValidIP4|isValidIP4Network|isValidIP4Host|getIP4NetworkByAdrAndMask|getDefaultNetmaskByIP4adr|parseUrl|createUrl|isPingReachable|isValidFQDN|cidrToNetmask|netmaskToCidr|isNumber|CompareDotSeparatedNumbers|calculate|DecStrToHexStr|HexStrToDecStr|RandomIntStr|sleepSeconds|markTime|diffTime|getDiffTimeSec|timeStampAsFloatStr|getProductMap|LoadProductProperties|getProductPropertyList|GetProductProperty|GetConfidentialProductProperty|setActionProgress|retrieveSection|replaceOpsiConstants|runningInWanMode|noUpdateScript|reloadProductList|NormalizeWinst|IconizeWinst|RestoreWinst|MaximizeWinst|Killtask|ChangeDirectory|GetProcessList|processIsRunning|isProcessChildOf|shellCall|powershellcall|getOutStreamFromSection|processCall|getLastExitCode|executeSection|isRegexMatch|getSubListByContainingRegex|getRegexMatchList|removeFromListByContainingRegex|stringReplaceRegex|stringReplaceRegexInList|getRegistryValue|GetRegistryStringValue32|GetRegistryStringValue64|GetRegistryStringValueSysNative|getRegistryKeyList32|getRegistryKeyList64|getRegistryKeyListSysnative|getRegistryKeyList|getRegistryVarList32|getRegistryVarList64|getRegistryVarListSysnative|getRegistryVarList|getRegistryVarMap32|getRegistryVarMap64|getRegistryVarMapSysnative|RegKeyExists|RegVarExists|splitString|splitStringOnWhiteSpace|contains|trim|lower|upper|unquote|unquote2|stringReplace|strLength|strPos|strPart|EscapeString|ReEncodeStr|RandomStr|CompareDotSeparatedStrings|boolToString|stringToBool|stringinput|regstring|ParamStr|GetReturnListFromSection|getListContaining|getListContainingList|getIndexFromListByContaining|count|emptylist|composeString|createStringList|reverse|getSubList|getSubListByMatch|getSubListByContaining|getSubListByKey|getKeyList|addtolist|addListToList|removeFromListByContaining|removeFromListByMatch|takeString|takeFirstStringContaining|setStringInListAtIndex|getValue|getValueBySeparator|setValueByKey|areListsEqual|ReEncodeStrList|editmap|GetOS|GetMsVersionInfo|GetMSVersionMap|getLinuxDistroType|getLinuxVersionMap|getMacosVersionInfo|getMacosVersionMap|GetSystemType|getOSArchitecture|getListFromWMI|EnvVar|getProfilesDirList|listFiles|which|runningAsAdmin|runningOnUefi|runningInPE|runningInWAnMode|isDriveReady|runningWithGui|GetLocaleInfoMap|HasMinimumSpace|chmod|waitForPackageLock|UpdateEnvironment|SidToName|getHWBiosInfoMap|GetShortWinPathName|GetUserSID|GetLoggedInUser|GetUsercontext|GetScriptMode|saveVersionToProfile|readVersionFromProfile|scriptWasExecutedBefore|isLoginScript|getXml2DocumentFromFile|getXml2Document|xml2GetFirstChildNodeByName|getXml2UniqueChildnodeByName|getXml2AttributeValueByKey|getXml2Text|XMLAddNamespace|XMLRemoveNamespace)\b
     - name: support.function.statement.opsi-script
       match: (?i)\b(LogError|LogWarning|Pause|Stop|Message|ShowMessageFile|ShowBitMap|comment|includelog|ExitWindows\s+/Reboot|ExitWindows\s+/ImmediateReboot|ExitWindows\s+/ImmediateLogout|ExitWindows\s+/ShutdownWanted)\b
     - name: keyword.control.include.opsi-script
       match: (?i)^\s*(include_insert|include_append|sub|importLib)\b

  primary-section-function-registry:
    patterns:
    - name: meta.function.registry.opsi-script
      match: (?i)\b(Registry)\b\s+(.*)\s+(/regedit|/addreg)\s*(\S*.*)
      captures:
        '1': {name: support.function.registry.opsi-script}
        '2':
          patterns:
          - include: '#expressions'
          - include: '#primary-section-functions'
        '3':
          name: constant.character.opsi-script
          patterns:
          - include: '#secondary-section-string'
        '4':
          patterns:
          - include: '#secondary-section-params-registry'

  primary-section-keywords:
    patterns:
    - name: keyword.opsi-script
      match: (?i)\b(DefVar|DefStringList|Set|DefFunc|EndFunc|void|string|stringlist|if|else|elseif|endif|in|to|do|Switch|EndSwitch|Case|DefaultCase|EndCase|and|or|not|val|ref)\b
    - name: meta.keyword.for-loop.opsi-script
      match: (?i)\b(for\s+)(%\w+%)\s+
      captures:
        '1': {name: keyword.for-loop.opsi-script}
        '2': {name: variable.other.for-loop.constant.opsi-script}

  primary-section-string:
    patterns:
    - include: '#literal-variable'
    - name: string.quoted.single.primary-section-string.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant-percent'

    - name: string.quoted.double.primary-section-string.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant-percent'

  primary-section-number:
    patterns:
    - name: constant.numeric.opsi-script
      match: (?xi)\b[0-9]+

  secondary-section-params-winbatch:
    patterns:
    - name: constant.character.param.letthemgo.opsi-script
      match: (?i)\/LetThemGo\b
    - name: constant.character.param.timeoutseconds.opsi-script
      match: (?i)\/TimeOutSeconds\b\s+\d+
    - name: constant.character.param.waitforprocessending.opsi-script
      match: (?i)(/WaitForProcessEnding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.waitforprocessending.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.waitforwindowappearing.opsi-script
      match: (?i)(/WaitForWindowAppearing)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.waitforwindowappearing.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.waitforwindowvanish.opsi-script
      match: (?i)(/WaitForWindowVanish)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.waitforwindowvanish.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.waitonclose.opsi-script
      match: (?i)\/WaitOnClose\b
    - name: constant.character.param.waitseconds.opsi-script
      match: (?i)\/WaitSeconds\b\s+\d+
    - name: constant.character.param.runelevated.opsi-script
      match: (?i)\/RunElevated\b
    - name: constant.character.param.runasloggedonuser.opsi-script
      match: (?i)\/RunAsLoggedOnUser\b
    - name: constant.character.param.32bit64bitsysnative.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b

  secondary-section-params-shellscript:
    patterns:
    - name: constant.character.param.winst.opsi-script
      match: (?i)\bwinst\b
    - name: constant.character.param.timeoutseconds.opsi-script
      match: (?i)\/TimeOutSeconds\b\s+\d+
    - name: constant.character.param.waitforprocessending.opsi-script
      match: (?i)(/WaitForProcessEnding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.waitforprocessending.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.runelevated.opsi-script
      match: (?i)\/RunElevated\b
    - name: constant.character.param.runasloggedonuser.opsi-script
      match: (?i)\/RunAsLoggedOnUser\b
    - name: constant.character.param.32bit64bitsysnative.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b
    - name: constant.character.param.showoutput.opsi-script
      match: (?i)\/showoutput\b
    - name: constant.character.param.encoding.opsi-script
      match: (?i)(/encoding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.encoding.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-params-execwith:
    patterns:
    - name: constant.character.param.pass.opsi-script
      match: (?i)\bpass\b
    - name: constant.character.param.winst.opsi-script
      match: (?i)\bwinst\b
    - name: constant.character.param.letthemgo.opsi-script
      match: (?i)\/LetThemGo\b
    - name: constant.character.param.escapestrings.opsi-script
      match: (?i)\/EscapeStrings\b
    - name: constant.character.param.runasloggedonuser.opsi-script
      match: (?i)\/RunAsLoggedOnUser\b
    - name: constant.character.param.32bit64bitsysnative.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b
    - name: constant.character.param.encoding.opsi-script
      match: (?i)(/encoding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.encoding.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-params-files:
    patterns:
    - name: constant.character.param.alluserprofiles.opsi-script
      match: (?i)\/AllUserProfiles\b
    - name: constant.character.param.allntusersendto.opsi-script
      match: (?i)\/AllNTUserSendTo\b
    - name: constant.character.param.32bit64bitsysnative.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b
    - name: invalid.deprecated.param.opsi-script
      match: (?i)\/(AllNTUserProfiles)\b

  secondary-section-params-registry:
    patterns:
    - name: constant.character.param.allntuserdats.opsi-script
      match: (?i)\/AllNTUserDats\b
    - name: constant.character.param.32bit64bitsysnative.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b
    - name: constant.character.param.regedit.opsi-script
      match: (?i)\/regedit\b
    - name: constant.character.param.addreg.opsi-script
      match: (?i)\/addReg\b

  secondary-section-params-patches:
    patterns:
    - name: constant.character.param.alluserprofiles.opsi-script
      match: (?i)\/AllUserProfiles\b
    - name: constant.character.param.encoding.opsi-script
      match: (?i)(/encoding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.encoding.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: invalid.deprecated.param.opsi-script
      match: (?i)\/(AllNTUserProfiles)\b

  secondary-section-params-patchtextfile:
    patterns:
    - name: constant.character.param.alluserprofiles.opsi-script
      match: (?i)\/AllUserProfiles\b
    - name: constant.character.param.encoding.opsi-script
      match: (?i)(/encoding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.encoding.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: invalid.deprecated.param.opsi-script
      match: (?i)\/(AllNTUserProfiles)\b

  secondary-section-params-opsiservicecall:
    patterns:
    - name: constant.character.param.serviceurl.opsi-script
      match: (?i)(/serviceurl)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.serviceurl.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.username.opsi-script
      match: (?i)(/username)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.username.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.password.opsi-script
      match: (?i)(/password)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.password.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: constant.character.param.interactive.opsi-script
      match: (?i)\/interactive\b
    - name: constant.character.param.preloginservice.opsi-script
      match: (?i)\/preloginservice\b
    - name: constant.character.param.opsiclientd.opsi-script
      match: (?i)\/opsiclientd\b
    - name: constant.character.param.opsiclientd-once.opsi-script
      match: (?i)\/opsiclientd-once\b

  secondary-section-params-xml2:
    patterns:
    - name: constant.character.param.alluserprofiles.opsi-script
      match: (?i)\/AllUserProfiles\b
    - name: constant.character.param.encoding.opsi-script
      match: (?i)(/encoding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.encoding.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'
    - name: invalid.deprecated.param.opsi-script
      match: (?i)\/(AllNTUserProfiles)\b

  secondary-section-params-execpython:
    patterns:
    - name: constant.character.param.letthemgo.opsi-script
      match: (?i)\/LetThemGo\b
    - name: constant.character.param.escapestrings.opsi-script
      match: (?i)\/EscapeStrings\b
    - name: constant.character.param.runasloggedonuser.opsi-script
      match: (?i)\/RunAsLoggedOnUser\b
    - name: constant.character.param.32bit64bitsysnative.opsi-script
      match: (?i)\/(32Bit|64Bit|SysNative)\b
    - name: constant.character.param.encoding.opsi-script
      match: (?i)(/encoding)\b\s+(["'].*["'])
      captures:
        '1': {name: constant.character.param.encoding.opsi-script}
        '2':
          patterns:
          - include: '#primary-section-string'

  secondary-section-params-ldapsearch:
    patterns:
    - name: constant.character.param.cache.opsi-script
      match: (?i)\/cache\b
    - name: constant.character.param.cached.opsi-script
      match: (?i)\/cached\b
    - name: constant.character.param.free.opsi-script
      match: (?i)\/free\b
    - name: constant.character.param.objects.opsi-script
      match: (?i)\/objects\b
    - name: constant.character.param.attributes.opsi-script
      match: (?i)\/attributes\b
    - name: constant.character.param.values.opsi-script
      match: (?i)\/values\b


  function-calls:
    patterns:
    - name: meta.function-call.opsi-script
      match: (?i)\b(\S+)(\([^\)]*\))
      captures:
        '1': {name: entity.name.type.function-call.opsi-script}
        '2':
          patterns:
          - include: '#round-brackets'

  sub-section-calls:
    patterns:
    - name: meta.sub-section-call.opsi-script
      match: (?i)\b(Sub_\w+)\b
      captures:
        '1': {name: entity.name.type.sub-section-call.opsi-script}

  secondary-section-calls:
    patterns:
    - name: meta.secondary-section-call.deprecated.opsi-script
      match: (?i)\b(IdapiConfig|progmangroups|XMLPatch|dosbatch|dosinanicon|shellbatch|shellinanicon)\S+\b\s*(.*)
      captures:
        '1': {name: invalid.deprecated.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.execwith.opsi-script
      match: (?i)\b(execwith_\w+)\b\s*(["'][^"']*["']|\S+)\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.execwith.interpreter.opsi-script
          patterns:
          - include: '#primary-section-string'
        '3':
          name: meta.secondary-section-call.execwith.params.opsi-script
          patterns:
          - include: '#secondary-section-params-execwith'

    - name: meta.secondary-section-call.winbatch.opsi-script
      match: (?i)\b(winbatch_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.winbatch.params.opsi-script
          patterns:
          - include: '#secondary-section-params-winbatch'

    - name: meta.secondary-section-call.shellscript.opsi-script
      match: (?i)\b(shellscript_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.shellscript.params.opsi-script
          patterns:
          - include: '#secondary-section-params-shellscript'

    - name: meta.secondary-section-call.files.opsi-script
      match: (?i)\b(files_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.files.params.opsi-script
          patterns:
          - include: '#secondary-section-params-files'

    - name: meta.secondary-section-call.registry.opsi-script
      match: (?i)\b(registry_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.registry.params.opsi-script
          patterns:
          - include: '#secondary-section-params-registry'

    - name: meta.secondary-section-call.patches.opsi-script
      match: (?i)\b(patches_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.patches.params.opsi-script
          patterns:
          - include: '#secondary-section-params-patches'

    - name: meta.secondary-section-call.patchtextfile.opsi-script
      match: (?i)\b(patchtextfile_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.patchtextfile.params.opsi-script
          patterns:
          - include: '#secondary-section-params-patchtextfile'

    - name: meta.secondary-section-call.linkfolder.opsi-script
      match: (?i)\b(linkfolder_\w+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.opsiservicecall.opsi-script
      match: (?i)\b(opsiservicecall_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.opsiservicecall.params.opsi-script
          patterns:
          - include: '#secondary-section-params-opsiservicecall'

    - name: meta.secondary-section-call.patchhosts.opsi-script
      match: (?i)\b(patchhosts_\w+)\b
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}

    - name: meta.secondary-section-call.xml2.opsi-script
      match: (?i)\b(xml2_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.xml2.params.opsi-script
          patterns:
          - include: '#secondary-section-params-xml2'

    - name: meta.secondary-section-call.execpython.opsi-script
      match: (?i)\b(execpython_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.execpython.params.opsi-script
          patterns:
          - include: '#secondary-section-params-execpython'

    - name: meta.secondary-section-call.ldapsearch.opsi-script
      match: (?i)\b(ldapsearch_\w+)\b\s*(.*)
      captures:
        '1': {name: entity.name.type.secondary-section-call.opsi-script}
        '2':
          name: meta.secondary-section-call.ldapsearch.params.opsi-script
          patterns:
          - include: '#secondary-section-params-ldapsearch'

  secondary-sections:
    patterns:
    - name: meta.secondary-section.deprecated.opsi-script
      begin: (?i)^\s*\[(IdapiConfig|progmangroups|XMLPatch|dosbatch|dosinanicon|shellbatch|shellinanicon)[^\]]+\]
      beginCaptures:
        '1': {name: invalid.deprecated.secondary-section.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.exec-with-powershell.opsi-script
      begin: (?i)^\s*\[(ExecWith_\w*powershell\w*)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-exec-with-powershell.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      contentName: meta.embedded.block.powershell
      patterns:
      - include: '#secondary-section'
      - include: source.powershell

    - name: meta.secondary-section.winbatch.opsi-script
      begin: (?i)^\s*\[(winbatch_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-winbatch.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      contentName: meta.embedded.block.general.opsi-script
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.shellscript.opsi-script
      begin: (?i)^\s*\[(shellscript_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-shellscript.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      contentName: meta.embedded.block.general.opsi-script
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.execwith.opsi-script
      begin: (?i)^\s*\[(execwith_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-execwith.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      contentName: meta.embedded.block.general.opsi-script
      patterns:
      - include: '#secondary-section'

    - name: meta.secondary-section.execpython.opsi-script
      begin: (?i)^\s*\[(execpython_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-execpython.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      contentName: meta.embedded.block.python
      patterns:
      - include: '#secondary-section'
      - include: source.python

    - name: meta.secondary-section.files.opsi-script
      begin: (?i)^\s*\[(files_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-files.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-files'

    - name: meta.secondary-section.registry.opsi-script
      begin: (?i)^\s*\[(registry_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-registry.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-registry'

    - name: meta.secondary-section.patches.opsi-script
      begin: (?i)^\s*\[(patches_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-patches.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patches'

    - name: meta.secondary-section.patchtextfile.opsi-script
      begin: (?i)^\s*\[(patchtextfile_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-patchtextfile.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patchtextfile'

    - name: meta.secondary-section.patchhosts.opsi-script
      begin: (?i)^\s*\[(patchhosts_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-patchhosts.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-patchhosts'

    - name: meta.secondary-section.linkfolder.opsi-script
      begin: (?i)^\s*\[(linkfolder_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-linkfolder.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-linkfolder'

    - name: meta.secondary-section.opsiservicecall.opsi-script
      begin: (?i)^\s*\[(opsiservicecall_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-opsiservicecall.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-opsiservicecall'

    - name: meta.secondary-section.xml2.opsi-script
      begin: (?i)^\s*\[(xml2_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-xml2.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-xml2'

    - name: meta.secondary-section.ldapsearch.opsi-script
      begin: (?i)^\s*\[(ldapsearch_\w+)\]
      beginCaptures:
        '1': {name: entity.name.type.secondary-section-ldapsearch.opsi-script}
      while: ^(?i)(?!\s*(\[.*\]|EndFunc)\s*$)
      patterns:
      - include: '#secondary-section'
      - include: '#secondary-section-ldapsearch'

  secondary-section:
    patterns:
    - include: '#comments'
    - include: '#secondary-section-string'
    - include: '#literal-constant-percent'
    - include: '#literal-variable'

  secondary-section-string:
    patterns:
    - include: '#literal-constant-percent'
    - include: '#literal-variable'
    - name: string.quoted.single.secondary-section-string.opsi-script
      begin: "'"
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (')|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant-percent'
      - include: '#literal-variable'

    - name: string.quoted.double.secondary-section-string.opsi-script
      begin: '"'
      beginCaptures:
        '0': {name: punctuation.definition.string.begin.opsi-script}
      end: (")|(\n)
      endCaptures:
        '1': {name: punctuation.definition.string.end.opsi-script}
        '2': {name: invalid.illegal.newline.opsi-script}
      patterns:
      - include: '#literal-constant-percent'
      - include: '#literal-variable'

  secondary-section-files:
    patterns:
    - name: keyword.control.secondary-section.files.opsi-script
      match: (?i)\b(checktargetpath|copy|delete|del|sourcepath|chmod|hardlink|symlink|rename|move|zipfile|unzipfile)\b

  secondary-section-registry:
    patterns:
    - name: variable.other.secondary-section.registry.opsi-script
      match: '(?i)\b(REG_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_MULTI_SZ)'
    - name: keyword.control.secondary-section.registry.opsi-script
      match: (?i)\b(OpenKey|set|add|supp|GetMultiSZFromFile|SaveValueToFile|DeleteVar|DeleteKey|Flushkey)\b
    - name: invalid.deprecated.secondary-section.registry.opsi-script
      match: (?i)\b(ReconstructFrom)\b

  secondary-section-patches:
    patterns:
    - name: keyword.control.secondary-section.patches.opsi-script
      match: (?i)\b(add|addnew|set|change|del|delsec|replace)\b

  secondary-section-patchtextfile:
    patterns:
    - name: keyword.control.secondary-section.patchtextfile.opsi-script
      match: (?i)\b(Set_Mozilla_Pref|AddStringListElement_To_Mozilla_Pref|findline|findline_startingwith|findline_containing|gototop|gotobottom|advanceline|deletetheline|addline|add_line|insertline|appendline|append_file|subtract_file|savetofile|sorted|setKeyValueSeparator|setValueByKey)\b
    - name: invalid.deprecated.secondary-section.patchtextfile.opsi-script
      match: (?i)\b(addstringlistelement_to_netscape_user_pref|set_netscape_user_pref)\b

  secondary-section-linkfolder:
    patterns:
    - name: variable.other.secondary-section.linkfolder.opsi-script
      match: '(?i)\b(desktop|sendto|startmenu|startup|programs|desktopdirectory|common_startmenu|common_programs|common_startup|common_desktopdirectory|AudioVideo|Audio|Video|Development|Education|Game|Graphics|Network|Office|Settings|System|Utility)'
    - name: keyword.control.secondary-section.linkfolder.opsi-script
      match: (?i)\b(set_basefolder|set_subfolder|delete_element|delete_subfolder|set_link|name|target|parameters|working_dir|icon_file|icon_index|shortcut|window_state|link_categories|end_link)\b

  secondary-section-patchhosts:
    patterns:
    - name: keyword.control.secondary-section.patchhosts.opsi-script
      match: (?i)\b(setaddr|setname|setalias|delalias|delhost|setComment)\b

  secondary-section-xml2:
    patterns:
    - name: variable.other.secondary-section.xml2.opsi-script
      match: '(?i)\b(True|False)'
    - name: keyword.control.secondary-section.xml2.opsi-script
      match: (?i)\b(strictMode|openNode|SetAttribute|AddAttribute|DeleteAttribute|addNewNode|setNodeText|DeleteNode|gotoParentNode|rootNodeOnCreate|setNodePair)\b

  secondary-section-ldapsearch:
    patterns:
    - name: keyword.control.secondary-section.ldapsearch.opsi-script
      match: '(?i)\b(targethost|targetport|user|password|dn|typesonly|attributes|filter)'

patterns:
  - include: '#core'
